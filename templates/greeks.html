{% extends "base.html" %}
{% block title %}Greeks – Options Toolkit{% endblock %}

{% block content %}
<h1>Black Model Prices & Greeks</h1>

<!-- Two parameter boxes -->
<div class="top-row">
  <!-- Primary -->
  <div class="card">
    <h2>Primary Option</h2>
    <div class="form-row">
      <label for="F1_input">Forward F</label>
      <input type="number" id="F1_input" min="1" step="0.1" value="100">
    </div>
    <div class="form-row">
      <label for="K1_input">Strike K</label>
      <input type="number" id="K1_input" min="1" step="0.1" value="100">
    </div>
    <div class="form-row">
      <label for="T1_input">Time to Expiry T (years)</label>
      <input type="number" id="T1_input" min="0.01" step="0.01" value="1">
    </div>
    <div class="form-row">
      <label for="sigma1_input">Volatility σ</label>
      <input type="number" id="sigma1_input" min="0.01" max="5" step="0.01" value="0.2">
    </div>
    <div class="form-row">
      <label for="r1_input">Rate r</label>
      <input type="number" id="r1_input" min="-1" max="1" step="0.001" value="0.01">
    </div>
    <div class="form-row">
      <label>Option Type</label>
      <div class="option-type-group">
        <label>
          <input type="radio" name="option_type_1" value="call" id="opt1_call" checked>
          Call
        </label>
        <label>
          <input type="radio" name="option_type_1" value="put" id="opt1_put">
          Put
        </label>
      </div>
    </div>
  </div>

  <!-- Comparison -->
  <div class="card">
    <h2>Comparison Option</h2>
    <div class="form-row">
      <label>
        <input type="checkbox" id="comparison_enabled">
        Enable comparison
      </label>
    </div>
    <div class="form-row">
      <label for="F2_input">Forward F</label>
      <input type="number" id="F2_input" min="1" step="0.1" value="100">
    </div>
    <div class="form-row">
      <label for="K2_input">Strike K</label>
      <input type="number" id="K2_input" min="1" step="0.1" value="100">
    </div>
    <div class="form-row">
      <label for="T2_input">Time to Expiry T (years)</label>
      <input type="number" id="T2_input" min="0.01" step="0.01" value="1">
    </div>
    <div class="form-row">
      <label for="sigma2_input">Volatility σ</label>
      <input type="number" id="sigma2_input" min="0.01" max="5" step="0.01" value="0.2">
    </div>
    <div class="form-row">
      <label for="r2_input">Rate r</label>
      <input type="number" id="r2_input" min="-1" max="1" step="0.001" value="0.01">
    </div>
    <div class="form-row">
      <label>Option Type</label>
      <div class="option-type-group">
        <label>
          <input type="radio" name="option_type_2" value="call" id="opt2_call" checked>
          Call
        </label>
        <label>
          <input type="radio" name="option_type_2" value="put" id="opt2_put">
          Put
        </label>
      </div>
    </div>
  </div>
</div>

<!-- Chart selection box -->
<div class="card">
  <h2>Charts to Display</h2>
  <div class="chart-toggle-group">
    <label><input type="checkbox" id="show_price" checked> Price</label>
    <label><input type="checkbox" id="show_delta" checked> Delta</label>
    <label><input type="checkbox" id="show_gamma" checked> Gamma</label>
    <label><input type="checkbox" id="show_theta" checked> Theta</label>
    <label><input type="checkbox" id="show_vega" checked> Vega</label>
    <label><input type="checkbox" id="show_vanna" checked> Vanna</label>
    <label><input type="checkbox" id="show_volga" checked> Volga</label>
    <label><input type="checkbox" id="show_rho" checked> Rho</label>
    <label><input type="checkbox" id="show_charm" checked> Charm</label>
  </div>
</div>

<!-- Charts -->
<div class="charts">
  <div class="chart-card" id="priceChartCard"><div id="priceChart"></div></div>
  <div class="chart-card" id="deltaChartCard"><div id="deltaChart"></div></div>
  <div class="chart-card" id="gammaChartCard"><div id="gammaChart"></div></div>
  <div class="chart-card" id="thetaChartCard"><div id="thetaChart"></div></div>
  <div class="chart-card" id="vegaChartCard"><div id="vegaChart"></div></div>
  <div class="chart-card" id="vannaChartCard"><div id="vannaChart"></div></div>
  <div class="chart-card" id="volgaChartCard"><div id="volgaChart"></div></div>
  <div class="chart-card" id="rhoChartCard"><div id="rhoChart"></div></div>
  <div class="chart-card" id="charmChartCard"><div id="charmChart"></div></div>
</div>
{% endblock %}

{% block body_scripts %}
<script>
  const API_URL = "{{ url_for('greeks.api_greeks') }}";

  function isComparisonEnabled() {
    return document.getElementById('comparison_enabled').checked;
  }

  function getOptionType1() {
    return document.getElementById('opt1_call').checked ? 'call' : 'put';
  }

  function getOptionType2() {
    return document.getElementById('opt2_call').checked ? 'call' : 'put';
  }

  function strikeLine(K) {
    return [{
      type: 'line',
      x0: K,
      x1: K,
      yref: 'paper',
      y0: 0,
      y1: 1,
      line: { dash: 'dot', width: 1, color: 'black' }
    }];
  }

  function strikeAnnotation(K) {
    return [{
      x: K,
      xref: 'x',
      y: 1.03,
      yref: 'paper',
      text: 'Strike K',
      showarrow: false,
      font: { size: 10 },
      align: 'center'
    }];
  }

  function setupChartToggle(cardId, checkboxId) {
    const card = document.getElementById(cardId);
    const cb = document.getElementById(checkboxId);
    const updateDisplay = () => {
      card.style.display = cb.checked ? 'block' : 'none';
    };
    cb.addEventListener('change', updateDisplay);
    updateDisplay();
  }

  function syncComparisonFromPrimaryIfDisabled() {
    if (!isComparisonEnabled()) {
      const F1 = document.getElementById('F1_input').value;
      const K1 = document.getElementById('K1_input').value;
      const T1 = document.getElementById('T1_input').value;
      const sigma1 = document.getElementById('sigma1_input').value;
      const r1 = document.getElementById('r1_input').value;

      document.getElementById('F2_input').value = F1;
      document.getElementById('K2_input').value = K1;
      document.getElementById('T2_input').value = T1;
      document.getElementById('sigma2_input').value = sigma1;
      document.getElementById('r2_input').value = r1;

      const opt1_call = document.getElementById('opt1_call').checked;
      document.getElementById('opt2_call').checked = opt1_call;
      document.getElementById('opt2_put').checked = !opt1_call;
    }
  }

  function updateComparisonInputsDisabledState() {
    const enabled = isComparisonEnabled();
    const ids = ['F2_input','K2_input','T2_input','sigma2_input','r2_input','opt2_call','opt2_put'];
    ids.forEach(id => {
      document.getElementById(id).disabled = !enabled;
    });
  }

  async function updateGreeks() {
    const primary = {
      F: parseFloat(document.getElementById('F1_input').value) || 100,
      K: parseFloat(document.getElementById('K1_input').value) || 100,
      T: parseFloat(document.getElementById('T1_input').value) || 1,
      sigma: parseFloat(document.getElementById('sigma1_input').value) || 0.2,
      r: parseFloat(document.getElementById('r1_input').value) || 0.01,
      option_type: getOptionType1()
    };

    const comparison_enabled = isComparisonEnabled();
    let comparison = null;
    if (comparison_enabled) {
      comparison = {
        F: parseFloat(document.getElementById('F2_input').value) || primary.F,
        K: parseFloat(document.getElementById('K2_input').value) || primary.K,
        T: parseFloat(document.getElementById('T2_input').value) || primary.T,
        sigma: parseFloat(document.getElementById('sigma2_input').value) || primary.sigma,
        r: parseFloat(document.getElementById('r2_input').value) || primary.r,
        option_type: getOptionType2()
      };
    }

    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ primary, comparison_enabled, comparison })
    });
    const data = await res.json();

    const p = data.primary;
    const cmpEnabled = data.comparison_enabled;
    const c = data.comparison;

    const F_grid_p = p.F_grid;
    const Kstrike = p.K;
    const shapes = strikeLine(Kstrike);
    const annotations = strikeAnnotation(Kstrike);

    function tracesFor(field, primaryColor) {
      const traces = [{
        x: F_grid_p,
        y: p[field + '_grid'],
        name: 'Primary',
        mode: 'lines',
        line: { color: primaryColor }
      }];
      if (cmpEnabled && c) {
        traces.push({
          x: c.F_grid,
          y: c[field + '_grid'],
          name: 'Comparison',
          mode: 'lines',
          line: { color: primaryColor, dash: 'dash' }
        });
      }
      return traces;
    }

    // axis config: if max |value| < 0.001, switch to scientific notation
    function yAxisConfig(field, title) {
      let ys = p[field + '_grid'].slice();
      if (cmpEnabled && c) {
        ys = ys.concat(c[field + '_grid']);
      }
      let maxAbs = 0;
      for (let v of ys) {
        const a = Math.abs(v);
        if (a > maxAbs) maxAbs = a;
      }
      if (maxAbs > 0 && maxAbs < 0.001) {
        return { title: title, tickformat: '.2e' };
      }
      return { title: title };
    }

    Plotly.react('priceChart', tracesFor('price', 'blue'), {
      title: 'Option Price vs Forward F',
      xaxis: { title: 'Forward F' },
      yaxis: yAxisConfig('price', 'Price'),
      shapes,
      annotations
    });

    Plotly.react('deltaChart', tracesFor('delta', 'red'), {
      title: 'Delta vs Forward F',
      xaxis: { title: 'Forward F' },
      yaxis: yAxisConfig('delta', 'Delta'),
      shapes,
      annotations
    });

    Plotly.react('gammaChart', tracesFor('gamma', 'green'), {
      title: 'Gamma vs Forward F',
      xaxis: { title: 'Forward F' },
      yaxis: yAxisConfig('gamma', 'Gamma'),
      shapes,
      annotations
    });

    Plotly.react('thetaChart', tracesFor('theta', 'orange'), {
      title: 'Theta vs Forward F',
      xaxis: { title: 'Forward F' },
      yaxis: yAxisConfig('theta', 'Theta'),
      shapes,
      annotations
    });

    Plotly.react('vegaChart', tracesFor('vega', 'purple'), {
      title: 'Vega vs Forward F',
      xaxis: { title: 'Forward F' },
      yaxis: yAxisConfig('vega', 'Vega'),
      shapes,
      annotations
    });

    Plotly.react('vannaChart', tracesFor('vanna', 'brown'), {
      title: 'Vanna vs Forward F',
      xaxis: { title: 'Forward F' },
      yaxis: yAxisConfig('vanna', 'Vanna'),
      shapes,
      annotations
    });

    Plotly.react('volgaChart', tracesFor('volga', 'teal'), {
      title: 'Volga vs Forward F',
      xaxis: { title: 'Forward F' },
      yaxis: yAxisConfig('volga', 'Volga'),
      shapes,
      annotations
    });

    Plotly.react('rhoChart', tracesFor('rho', 'darkmagenta'), {
      title: 'Rho vs Forward F',
      xaxis: { title: 'Forward F' },
      yaxis: yAxisConfig('rho', 'Rho'),
      shapes,
      annotations
    });

    Plotly.react('charmChart', tracesFor('charm', 'darkcyan'), {
      title: 'Charm vs Forward F',
      xaxis: { title: 'Forward F' },
      yaxis: yAxisConfig('charm', 'Charm'),
      shapes,
      annotations
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    ['F1_input','K1_input','T1_input','sigma1_input','r1_input'].forEach(id => {
      document.getElementById(id).addEventListener('input', () => {
        syncComparisonFromPrimaryIfDisabled();
        updateGreeks();
      });
    });
    document.getElementById('opt1_call').addEventListener('change', () => {
      syncComparisonFromPrimaryIfDisabled();
      updateGreeks();
    });
    document.getElementById('opt1_put').addEventListener('change', () => {
      syncComparisonFromPrimaryIfDisabled();
      updateGreeks();
    });

    ['F2_input','K2_input','T2_input','sigma2_input','r2_input'].forEach(id => {
      document.getElementById(id).addEventListener('input', updateGreeks);
    });
    document.getElementById('opt2_call').addEventListener('change', updateGreeks);
    document.getElementById('opt2_put').addEventListener('change', updateGreeks);

    document.getElementById('comparison_enabled').addEventListener('change', () => {
      if (!isComparisonEnabled()) {
        syncComparisonFromPrimaryIfDisabled();
      }
      updateComparisonInputsDisabledState();
      updateGreeks();
    });

    setupChartToggle('priceChartCard', 'show_price');
    setupChartToggle('deltaChartCard', 'show_delta');
    setupChartToggle('gammaChartCard', 'show_gamma');
    setupChartToggle('thetaChartCard', 'show_theta');
    setupChartToggle('vegaChartCard', 'show_vega');
    setupChartToggle('vannaChartCard', 'show_vanna');
    setupChartToggle('volgaChartCard', 'show_volga');
    setupChartToggle('rhoChartCard', 'show_rho');
    setupChartToggle('charmChartCard', 'show_charm');

    updateComparisonInputsDisabledState();
    syncComparisonFromPrimaryIfDisabled();
    updateGreeks();
  });
</script>
{% endblock %}
